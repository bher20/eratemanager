{{- if .Values.refreshHook.enabled | default true }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "eratemanager.fullname" . | trunc 50 }}-refresh-all-hook
  labels:
    app: {{ include "eratemanager.name" . }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: refresh-all-providers
          image: curlimages/curl:8.10.1
          args:
            - /bin/sh
            - -c
            - |
              echo "Waiting for eRateManager backend..."
              until curl -fsSL "http://eratemanager:80/readyz"; do
                echo "Backend not ready yet..."
                sleep 2
              done

              echo "Backend is UP, discovering providers..."
              
              # Get all provider keys from the /providers endpoint
              PROVIDERS=$(curl -fsSL "http://eratemanager:80/providers" | \
                grep -o '"key":"[^"]*"' | \
                sed 's/"key":"//g' | \
                sed 's/"//g')
              
              if [ -z "$PROVIDERS" ]; then
                echo "No providers found, exiting."
                exit 0
              fi
              
              echo "Found providers: $PROVIDERS"
              
              # Refresh each provider
              for p in $PROVIDERS; do
                echo "Refreshing provider: $p"
                curl -fsSL "http://eratemanager:80/internal/refresh/$p" || echo "Warning: Failed to refresh $p"
                sleep 1
              done
              
              echo "All providers refreshed."
{{- end }}
